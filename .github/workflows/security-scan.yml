name: Security Scan - Environment Configuration

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/config/**'
      - 'src/security/**'
      - '.github/workflows/security-scan.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/config/**'
      - 'src/security/**'
      - '.github/workflows/security-scan.yml'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint security plugin
        run: |
          npx eslint --ext .ts,.js src/config/ src/security/ --fix || true

      - name: Run Snyk to check for vulnerabilities
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: Run security audit
        run: |
          npm audit --audit-level=high

      - name: Run Node.js specific security checks
        run: |
          # Check for hardcoded secrets
          echo "Checking for hardcoded secrets..."
          ! grep -r "ghp_[a-zA-Z0-9]" src/ --exclude-dir=node_modules || echo "WARNING: Potential GitHub PAT found"
          ! grep -r "gho_[a-zA-Z0-9]" src/ --exclude-dir=node_modules || echo "WARNING: Potential GitHub OAuth token found"
          ! grep -r "ghu_[a-zA-Z0-9]" src/ --exclude-dir=node_modules || echo "WARNING: Potential GitHub user-to-server token found"
          ! grep -r "ghs_[a-zA-Z0-9]" src/ --exclude-dir=node_modules || echo "WARNING: Potential GitHub server-to-server token found"

      - name: Run CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          languages: javascript-typescript
          queries: security-extended,security-and-quality

  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Check for outdated dependencies
        run: |
          npm outdated || echo "Some dependencies are outdated"

      - name: Check for vulnerable dependencies
        run: |
          npm audit --audit-level=moderate